name: CI Develop

on:
    push:
        branches-ignore:
            - release
            - main
            - develop
    pull_request:
        types: [synchronize]
    workflow_dispatch:

env:
    NODE_VERSION: 16.19.0
    FE_NEXTJS_PROJECT_ROOT: frontend/portfolio-website

jobs:
    prepare:
        name: Prepare
        runs-on: ubuntu-latest
        steps:
            - name: "📥  Checkout repository"
              uses: actions/checkout@v3

            - name: "🔍  Verify Changed Files"
              uses: tj-actions/changed-files@v35
              id: changed-frontend-portfolio-website-files
              with:
                  files: ${{ env.FE_NEXTJS_PROJECT_ROOT }}/**/*

            - name: "🔄  Cache node_modules"
              uses: actions/cache@v2
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: ${{ runner.os }}-node-

            - name: "🔧  Setup NodeJS ${{ env.NODE_VERSION }}"
              uses: actions/setup-node@v1
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: "🔧  Install npm@latest & CI Deps"
              run: |
                  npm i -g npm@latest
                  npm ci

    formatting:
        name: Formatting
        needs: prepare
        runs-on: ubuntu-latest
        steps:
            - name: "Check code formatting"
              run: |
                  npm run format:check

    linting:
        name: Linting
        needs: formatting
        runs-on: ubuntu-latest
        steps:
            - name: "Check code linting"
              run: |
                  npm run lint

    unit-tests:
        name: Unit Tests
        needs: linting
        runs-on: ubuntu-latest
        steps:
            - name: "Run unit tests"
              run: |
                  npm run test:unit

    integration-tests:
        name: Integration Tests
        needs: unit-tests
        runs-on: ubuntu-latest
        steps:
            - name: "Run integration tests"
              run: |
                  npm run test:integration

    build:
        name: Build
        needs: integration-tests
        runs-on: ubuntu-latest
        steps:
            - name: "Build project"
              run: |
                  npm run build

    package:
        name: Package
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: "Package project"
              run: |
                  npm run package
